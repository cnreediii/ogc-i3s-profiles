== Point Cloud Scene Layer

=== Introduction

Point cloud scene layers quickly display large volumes of symbolized and filtered point cloud data. They are optimized 
for the displaying and sharing a variety of sensor data, including LiDAR.  

Point cloud scene layers are scalable, which allows for efficiency when working with large datasets.  While rendering 
very large point cloud datasets can be slow and limited by hardware, point cloud scene layers are efficient because they 
are rendered at an optimized point resolution for the specified area. 

Point cloud scene layers also support caching attributes like RGB, Intensity, Flags, Class Code, Returns, User Data, 
Point Source ID, GPS Time, Scan Angle and Near Infrared.  This allows client applications to update the symbology as 
well as query point information.

[#img_pointcloud,reftext='{figure-caption} {counter:figure-num}']
.Example of point cloud rendering
image::images/PointCloud.png[width=600,align="center"]

=== Point Cloud Scene Layer Structure

The point cloud scene layer is structured into a tree of multiple JSON files. Beside storing information in the JSON format, 
some are also provided as binary buffer. Point cloud scene layers can be used to create a scene layer package (*.slpk) or a 
I3S service. Since an *.slpk file can contain millions of documents, an [SLPK hash table](slpk_hash_table.pcsl.md) improves 
performance when scanning the slpk. A point cloud scene layer contains the following:

- [Layer description](layer.pcsl.md)
- Nodes containing [Geometry](defaultGeometrySchema.pcsl.md) and [Attributes](attributeInfo.pcsl.md)
- [Node pages](nodepage.pcsl.md)
- [Statistics](statistics.pcsl.md)

=== Example of point cloud layer structure

```
.<host>/SceneServer/layers
	+--0 // layer description (named 3dSceneLayer.json in SLPK)
	+-- nodepages
	|  +-- 0
	|  +-- 1   
	|  +-- 2  
	|  +-- (...)
	|  +-- 4  
	+-- nodes
	|  +--0
	|  |  +-- attributes
	|  |  |  +--2 
	|  |  |  +--4
	|  |  |  +--8
	|  |  |  +--(...)
	|  |  +-- geometries
	|  |  |  +-- 0
	|  +--1 
	|  |  (...) //same structure for all nodes
	|  +--...
	|  +-- 259
	|  |  (...) //same structure for all nodes
	+--statistics
	|  +-- 2
	|  +-- 4
	|  +-- 8
	|  +-- (...)
```
=== HTTP API Overview

The following API methods are available for accessing a point cloud scene layer:

[width="90%",options="header"]
|===
|Method|Example
|To query SceneLayer document|http://my.server.com/layers/0
|To query attribute, statistics, documents|http://my.server.com/layers/0/statistics/{AttribKey}
|To query  NodePage  document|http://my.server.com/layers/0/nodepages/{firstNodeIdInPage} 
|To query  Geometry  Buffer|http://my.server.com/layers/0/nodes/{resourceID}/geometries/0 
|To query  Attribute  Buffer|http://my.server.com/layers/0/nodes/{resourceID}/attributes/{AttribKey}  _Note:  {AttribKey}  is listed in  `layer.attributeStorageInfo[].key`
|===

=== I3S point cloud scene layer definition

Describes the point cloud scene layer.

==== Properties

[width="90%",options="header"]
|===
| Property | Type | Description 
| **id** | integer | A unique identifying number for the layer. For point cloud scene layer, only a single layer is supported, therefore, id is always 0.
| **layerType** | string | String indicating the layer type<div>Must be:<ul><li>`PointCloud`</li></ul></div> 
| **name** | string | Represents the layer name. 
| alias | string | Represents the alias layer name. 
| desc | string | Description for the layer. 
| copyrightText | string | Copyright information to be displayed with this layer. 
| capabilities | string[] | Capabilities supported by this layer.<div>Possible values for each array string:<ul><li>`View`: View is supported.</li><li>`Query`: Query is supported.</li></ul></div> 
| **spatialReference** | [spatialReference](spatialReference.cmn.md) | An object containing the WKID or WKT identifying the spatial reference of the layer's geometry. 
| heightModelInfo | [heightModelInfo](heightModelInfo.cmn.md) | An object containing the vertical coordinate system information. 
| serviceUpdateTimeStamp | [serviceUpdateTimeStamp](serviceUpdateTimeStamp.cmn.md) | Object to provide time stamp when the I3S service or the source of the service was created or updated. 
| **store** | [store](store.pcsl.md) | The storage for the layer. 
| **attributeStorageInfo** | [attributeInfo](attributeInfo.pcsl.md)[] | List of attributes included for this layer. 
| drawingInfo | [drawingInfo](drawingInfo.pcsl.md) | An object containing drawing information. 
| elevationInfo | [elevationInfo](elevationInfo.pcsl.md) | An object containing elevation information. 
| fields | [field](field.cmn.md)[] |  |
|===

*Note: properties in **bold** are required*

==== Example: Point cloud layer 

```json
 {
    "id": 0,
    "layerType": "PointCloud",
    "name": "Test Data",
    "desc": "Nice Test data",
    "capabilities": [
      "View"
    ],
    "spatialReference": {
        "wkid": 4326,
        "latestWkid": 4326,
        "vcsWkid": 5703,
        "latestVcsWkid": 5703
    },
    "store": {
        "id": "",
        "profile": "PointCloud",
        "version": "2.0",
        "extent": [
            -122.45945212669568,
            38.298060753040346,
            -122.43014691292728,
            38.303939889306761
        ],
        "index": {
            "nodeVersion": 1,
            "boundingVolumeType": "obb",
            "nodesPerPage": 64,
            "lodSelectionMetricType": "density-threshold"
        },
        "defaultGeometrySchema": {
            "geometryType": "points",
            "header": [],
            "topology": "PerAttributeArray",
            "encoding": "lepcc-xyz",
            "vertexAttributes": {
                "position": {
                    "valueType": "Float64",
                    "valuesPerElement": 3
                }
            },
            "ordering": [
                "position"
            ]
        }
    },
    "attributeStorageInfo": [
        {
            "key": "1",
            "name": "ELEVATION",
            "encoding": "embedded-elevation"
        },
        {
            "key": "2",
            "name": "INTENSITY",
            "ordering": [
                "attributeValues"
            ],
            "attributeValues": {
                "valueType": "UInt16",
                "valuesPerElement": 1
            },
            "encoding": "lepcc-intensity"
        },
        {
            "key": "4",
            "name": "RGB",
            "ordering": [
                "attributeValues"
            ],
            "attributeValues": {
                "valueType": "UInt8",
                "valuesPerElement": 3
            },
            "encoding": "lepcc-rgb"
        },
        {
            "key": "8",
            "name": "CLASS_CODE",
            "ordering": [
                "attributeValues"
            ],
            "attributeValues": {
                "valueType": "UInt8",
                "valuesPerElement": 1
            }
        },
        {
            "key": "16",
            "name": "FLAGS",
            "ordering": [
                "attributeValues"
            ],
            "attributeValues": {
                "valueType": "UInt8",
                "valuesPerElement": 1
            }
        },
        {
            "key": "32",
            "name": "RETURNS",
            "ordering": [
                "attributeValues"
            ],
            "attributeValues": {
                "valueType": "UInt8",
                "valuesPerElement": 1
            }
        }
    ],
    "drawingInfo": {
        "renderer": {
            "pointSizeAlgorithm": {
                "type": "pointCloudSplatAlgorithm",
                "scaleFactor": 1,
                "minSize": 4
            },
            "pointsPerInch": 25,
            "field": "ELEVATION",
            "fieldTransformType": "none",
            "colorModulation": {
                "field": "",
                "minValue": 1,
                "maxValue": 255
            },
            "type": "pointCloudStretchRenderer",
            "stops": [
                {
                    "value": 23.91416560580215,
                  "color": [
                    88,
                    19,
                    252,
                    255
                  ]
                },
                {
                    "value": 59.9739474458430379,
                    "color": [
                        8,
                        252,
                        253,
                        255
                    ]
                },
                {
                    "value": 96.033729285883922,
                    "color": [
                        242,
                        254,
                        42,
                        255
                    ]
                },
                {
                    "value": 132.093511125924806,
                    "color": [
                        255,
                        43,
                        24,
                        255
                    ]
                }
            ]
        }
    },
    "elevationInfo": {
        "mode": "absoluteHeight"
    },
    "heightModelInfo": {
        "heightModel": "gravity_related_height",
        "vertCRS": "NAVD_1988",
        "heightUnit": "meter"
    }
} 
```

=== I3S point cloud scene layer: defaultGeometrySchema

Attribute description as field.

### Related:

[pcsl::store](store.pcsl.md)

==== Properties

[width="90%",options="header"]
|===
| Property | Type | Description 
| **geometryType** | string | The type of primitive. Only points are supported for point cloud scene layer.<div>Must be:<ul><li>`points`</li></ul></div> 
| header | [] | The header in binary buffers. Currently not supported for point cloud scene layer. 
| **topology** | string | This property is currently **ignored* for point cloud scene layer since it only contains geometry position without vertex attributes.<div>Must be:<ul><li>`PerAttributeArray`</li></ul></div> 
| **encoding** | string | Only 'lepcc-xyz' compression is currently supported.<div>Must be:<ul><li>`lepcc-xyz`</li></ul></div> 
| ordering | string[] | Currently the geometry contains XYZ only, so vertex attribute must only list 'position'.<div>Possible values for each array string:<ul><li>`position`: vertex coordinates</li></ul></div> 
| **vertexAttributes** | [vertexAttributes](vertexAttributes.pcsl.md) | The vertex buffer description. 
|===

*Note: properties in **bold** are required* 

==== Example: defaultGeometrySchema 

```json
 {
  "geometryType": "points",
  "header": [],
  "topology": "PerAttributeArray",
  "encoding": "lepcc-xyz",
  "vertexAttributes": {
    "position": {
      "valueType": "Float64",
      "valuesPerElement": 3
    }
  },
  "ordering": [
    "position"
  ]
} 
```

=== I3S point cloud scene layer: store

This class describes the storage properties for the layer.

==== Related:

Class layer, Class Index, Class defaultGeometrySchema

==== Properties

[width="90%",options="header"]
|===
| Property | Type | Description
| id | string | Id for the store. Not currently used by the point cloud scene layer. 
| **profile** | string | Defines the profile type of the scene layer as point cloud scene layer.<div>Must be:<ul><li>`PointCloud`</li></ul></div> 
| **version** | string | Point cloud scene layer store version. 
| **extent** | number[4] | 2D extent of the point cloud scene layer in the layers spatial reference units. 
| **index** | [index](index.pcsl.md) | Describes the index (i.e. bounding volume tree) of the layer. 
| **defaultGeometrySchema** | [defaultGeometrySchema](defaultGeometrySchema.pcsl.md) | Attribute description as field. 
| geometryEncoding | string | MIME type for the encoding used for the Geometry Resources. For example: application/octet-stream; version=1.6. 
| attributeEncoding | string | MIME type for the encoding used for the Attribute Resources. For example: application/octet-stream; version=1.6. 
|===

*Note: properties in **bold** are required*

==== Example: store 

```json
 {
  "id": "",
  "profile": "PointCloud",
  "version": "2.0",
  "extent": [
    -105.023403,
    39.740089,
    -105.011746,
    39.757051
  ],
  "index": {
    "nodeVersion": 1,
    "boundingVolumeType": "obb",
    "nodesPerPage": 64,
    "lodSelectionMetricType": "density-threshold"
  },
  "defaultGeometrySchema": {
    "geometryType": "points",
    "header": [],
    "topology": "PerAttributeArray",
    "encoding": "lepcc-xyz",
    "vertexAttributes": {
      "position": {
        "valueType": "Float64",
        "valuesPerElement": 3
      }
    },
    "ordering": [
      "position"
    ]
  }
} 
```

=== I3S point cloud scene layer: index

Class Index describes the properties of the index (i.e. bounding volume tree) of the layer.

==== Related classes

class store

==== Properties

[width="90%",options="header"]
|===
| Property | Type | Description
| **nodeVersion** | integer | The version of the individual nodes format.
| **nodesPerPage** | integer | The page size describes the number of nodes per paged index document. 64 is currently expected.
| boundingVolumeType | string | The bounding volume type. Only OBB is currently supported.<div>Must be:<ul><li>`obb`: Oriented bounding box</li></ul></div>
| lodSelectionMetricType | string | Defines how `node.lodThreshold` should be interpreted<div>Must be:<ul><li>`density-threshold`: nodes[i].lodThreshold will represent an 'effective' 2D area for the node. This estimation works best when the point cloud scene layer represents a surface and is not volumetric. World space density is defined as Dw = node.pointCount / node.effectiveArea.  Ds is Dw converted to screen space. Client would switch LOD when Ds is less/greater than a threshold defined by the client. For example, 0.1 point per pixel square. Note for point cloud scene layer creation: If each point footprint is assumed to be identical (say 0.1x0.1 unit), then the lodThreshold may be computed as number_of_points * point_footprint for a leaf node and sum( children[i].effective_area) for inner nodes.</li></ul></div> |
| href | string | 
|===

*Note: properties in **bold** are required*

==== Example of Index for Point Cloud Layer

```json
 {
  "nodeVersion": 1,
  "boundingVolumeType": "obb",
  "nodesPerPage": 64,
  "lodSelectionMetricType": "density-threshold"
} 
```
